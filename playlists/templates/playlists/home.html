{% extends 'base_site.html' %}
{% load static %}

{% block title %}Relaxify - {% if current_filter == 'collections' %}YouTube Playlists{% elif current_filter == 'tracks' %}Individual Tracks{% else %}All Music{% endif %}{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Filter Section -->
    <div class="btn-group mb-3 justify-content-center align-items-center" role="group" aria-label="Filter">
        <a href="{% url 'playlists:home' %}?filter=all" class="btn btn btn-outline-info {% if current_filter == 'all' %}active{% endif %}" data-filter="all">
            ðŸŽ¼ All
        </a>
        <a href="{% url 'playlists:home' %}?filter=collections" class="btn btn btn-outline-success {% if current_filter == 'collections' %}active{% endif %}" data-filter="collections">
            ðŸŽµ Collections
        </a>
        <a href="{% url 'playlists:home' %}?filter=tracks" class="btn btn btn-outline-danger {% if current_filter == 'tracks' %}active{% endif %}" data-filter="tracks">
            ðŸŽ§ Tracks
        </a>
    </div>

    <!-- Collections Section -->
    {% if collections %}
        <hr>
        <div class="mb-5">
            <h2 class="section-title">
                <i class="fas fa-layer-group"></i> Your Collections
            </h2>
            <p class="section-subtitle">
                Organized playlists from YouTube
            </p>
            
            <div class="row">
                {% for collection in collections %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="collection-card">
                        {% if collection.platform == 'youtube' %}
                            <div class="platform-badge">
                                <i class="fab fa-youtube"></i> YouTube
                            </div>
                        {% elif collection.platform == 'youtube_music' %}
                            <div class="platform-badge">
                                <i class="fab fa-youtube"></i> YouTube
                            </div>
                        {% else %}
                            <div class="platform-badge platform-mixed">
                                <i class="fas fa-layer-group"></i> Mixed
                            </div>
                        {% endif %}
                        
                        {% if collection.thumbnail_url %}
                            <div class="collection-thumbnail-container"
                                 data-collection-id="{{ collection.id }}"
                                 data-collection-name="{{ collection.name|escapejs }}"
                                 data-collection-platform="{{ collection.platform }}"
                                 data-collection-count="{{ collection.playlist_count }}"
                                 style="cursor: pointer;">
                                <img src="{{ collection.thumbnail_url }}" class="collection-thumbnail" alt="{{ collection.name }}">
                            </div>
                        {% else %}
                            <div class="collection-placeholder collection-thumbnail-container"
                                 data-collection-id="{{ collection.id }}"
                                 data-collection-name="{{ collection.name|escapejs }}"
                                 data-collection-platform="{{ collection.platform }}"
                                 data-collection-count="{{ collection.playlist_count }}"
                                 style="cursor: pointer;">
                                {% if collection.platform == 'youtube' %}
                                    <i class="fab fa-youtube text-white icon-large"></i>
                                {% elif collection.platform == 'youtube_music' %}
                                    <i class="fab fa-youtube text-white icon-large"></i>
                                {% else %}
                                    <i class="fas fa-layer-group text-white icon-large"></i>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        <h3 class="collection-title">{{ collection.name }}</h3>
                        
                        {% if collection.description %}
                            <p class="collection-description">
                                {{ collection.description|truncatewords:15 }}
                            </p>
                        {% endif %}
                        
                        <div class="collection-stats">
                            <div class="collection-stat">
                                <i class="fas fa-music"></i>
                                <span>{{ collection.playlist_count }} track{{ collection.playlist_count|pluralize }}</span>
                            </div>
                            {% if collection.total_duration_formatted %}
                                <div class="collection-stat">
                                    <i class="fas fa-clock"></i>
                                    <span>{{ collection.total_duration_formatted }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <hr>
    <!-- Individual Tracks Section -->
    {% if individual_tracks %}
        <div class="mb-5">
            <h2 class="section-title">
                <i class="fas fa-music"></i> Individual Tracks
            </h2>
            <p class="section-subtitle">
                Standalone tracks not part of any collection
            </p>
 
            <div class="row">
                {% for track in individual_tracks %}
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="track-card" onclick="playTrack('{{ track.youtube_id }}', '{{ track.title|escapejs }}')">
                        {% if track.thumbnail_url %}
                            <img src="{{ track.thumbnail_url }}" class="track-thumbnail" alt="{{ track.title }}">
                        {% else %}
                            <div class="track-thumbnail track-thumbnail-placeholder">
                                <i class="fas fa-music text-white icon-medium"></i>
                            </div>
                        {% endif %}
                        
                        <h4 class="track-title">{{ track.title }}</h4>
                        
                        {% if track.artist %}
                            <div class="track-artist">{{ track.artist }}</div>
                        {% endif %}
                        
                        <div class="track-meta">
                            <span>
                                <i class="fas fa-eye"></i> {{ track.view_count|floatformat:0 }}
                            </span>
                            {% if track.duration %}
                                <span>{{ track.duration }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    
    <!-- Import CTA -->
    {% if not collections and not individual_tracks %}
        <div class="empty-state">
            <i class="fas fa-music"></i>
            <h3>No music collections yet</h3>
            <p>Start by importing your favorite YouTube playlists or individual tracks!</p>
        </div>
    {% endif %}
    <div class="import-cta" data-import-url="{% url 'playlists:import' %}">
        <i class="fas fa-plus-circle mb-3 large-icon"></i>
        <h3 class="text-white mb-2">Import More Music</h3>
        <p class="text-white-50 mb-3">
            Import YouTube playlists or individual tracks
        </p>
        <a href="{% url 'playlists:import' %}" class="btn btn-primary">
            <i class="fas fa-download"></i> Import Playlist
        </a>
        <a href="{% url 'playlists:offline_manager' %}" class="btn btn-outline-light ms-2">
            <i class="fas fa-wifi-slash"></i> Offline Manager
        </a>
    </div>
</div>

<!-- YouTube Player Modal -->
<div class="modal fade" id="playerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="playerModalTitle">Now Playing</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="player"></div>
            </div>
        </div>
    </div>
</div>

<!-- Collection Player Modal -->
<div class="modal fade" id="collectionPlayerModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="collectionPlayerModalTitle">Collection Player</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="collection-player-container">
                    <!-- Video Section -->
                    <div class="video-section">
                        <!-- Video Player -->
                        <div class="video-player" id="collection-video-container">
                            <div class="loading-placeholder" id="collection-loading-placeholder">
                                <div class="spinner"></div>
                                <p>Loading player...</p>
                            </div>
                            <div id="collection-youtube-player"></div>
                        </div>

                        <!-- Video Info -->
                        <div class="video-info">
                            <h1 class="video-title" id="collection-current-title">Select a track to start playing</h1>
                            <div class="video-artist" id="collection-current-artist">Choose from the playlist on the right</div>
                            <div class="video-stats">
                                <span><i class="fas fa-clock"></i> <span id="collection-current-duration">--:--</span></span>
                                <span><i class="fas fa-eye"></i> <span id="collection-current-views">--</span> views</span>
                            </div>
                        </div>
                    </div>

                    <!-- Playlist Section -->
                    <div class="playlist-section">
                        <!-- Playlist Header -->
                        <div class="playlist-header">
                            <div class="playlist-title" id="collection-playlist-title">
                                Loading...
                            </div>
                            <div class="playlist-subtitle" id="collection-playlist-subtitle">
                                <span class="playlist-count">0 tracks</span>
                            </div>
                        </div>

                        <!-- Track List -->
                        <div class="track-list" id="collection-track-list">
                            <div style="text-align: center; padding: 2rem; color: #aaa;">
                                <i class="fas fa-music" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>Loading tracks...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let player;
let playerModal;
let collectionPlayer;
let collectionPlayerModal;
let collectionTracks = [];
let currentCollectionTrackIndex = -1;
let isCollectionPlaying = false;

function playTrack(videoId, title) {
    if (!playerModal) {
        playerModal = new bootstrap.Modal(document.getElementById('playerModal'));
    }
    
    document.getElementById('playerModalTitle').textContent = title;
    
    if (player) {
        player.loadVideoById(videoId);
    } else {
        // Load YouTube API
        if (!window.YT) {
            const script = document.createElement('script');
            script.src = 'https://www.youtube.com/iframe_api';
            document.head.appendChild(script);
            
            window.onYouTubeIframeAPIReady = function() {
                initPlayer(videoId);
            };
        } else {
            initPlayer(videoId);
        }
    }
    
    playerModal.show();
}

function initPlayer(videoId) {
    player = new YT.Player('player', {
        height: '390',
        width: '640',
        videoId: videoId,
        playerVars: {
            'playsinline': 1,
            'rel': 0,
            'modestbranding': 1
        }
    });
}

// Stop video when modal is closed
document.getElementById('playerModal').addEventListener('hidden.bs.modal', function() {
    if (player && player.pauseVideo) {
        player.pauseVideo();
    }
});

// Collection Player Functions
async function openCollectionPlayer(collectionId, collectionName, platform, trackCount) {
    if (!collectionPlayerModal) {
        collectionPlayerModal = new bootstrap.Modal(document.getElementById('collectionPlayerModal'));
    }

    // Update modal title
    document.getElementById('collectionPlayerModalTitle').textContent = collectionName;
    document.getElementById('collection-playlist-title').textContent = collectionName;
    document.getElementById('collection-playlist-subtitle').innerHTML = `
        <span class="platform-badge">
            <i class="fab fa-youtube"></i> YouTube
        </span>
        <span class="playlist-count">${trackCount} tracks</span>
    `;

    // Show loading state
    document.getElementById('collection-track-list').innerHTML = `
        <div style="text-align: center; padding: 2rem; color: #aaa;">
            <div class="spinner"></div>
            <p>Loading tracks...</p>
        </div>
    `;

    // Load collection data
    try {
        const response = await fetch(`/api/collections/${collectionId}/`);
        const collectionData = await response.json();

        collectionTracks = collectionData.playlists || [];

        // Render track list
        renderCollectionTrackList();

        // Show modal
        collectionPlayerModal.show();

    } catch (error) {
        console.error('Error loading collection:', error);
        document.getElementById('collection-track-list').innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #ff4444;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <p>Error loading collection</p>
            </div>
        `;
        collectionPlayerModal.show();
    }
}

function renderCollectionTrackList() {
    const trackList = document.getElementById('collection-track-list');

    if (collectionTracks.length === 0) {
        trackList.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #aaa;">
                <i class="fas fa-music" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <p>No tracks in this collection</p>
            </div>
        `;
        return;
    }

    trackList.innerHTML = collectionTracks.map((track, index) => `
        <div class="track-item" onclick="playCollectionTrack(${index})">
            <div class="track-number" id="collection-track-number-${index}">
                ${index + 1}
            </div>

            ${track.thumbnail_url ?
                `<img src="${track.thumbnail_url}" alt="${track.title}" class="track-thumbnail">` :
                `<div class="track-thumbnail-placeholder">
                    <i class="fas fa-music" style="font-size: 0.7rem; color: rgba(255,255,255,0.5);"></i>
                </div>`
            }

            <div class="track-info">
                <div class="track-title">${track.title}</div>
                <div class="track-artist">${track.artist || 'Unknown Artist'}</div>
            </div>

            <div class="track-duration">${track.duration || '--:--'}</div>
        </div>
    `).join('');
}

function playCollectionTrack(index) {
    if (currentCollectionTrackIndex === index && collectionPlayer && isCollectionPlaying) {
        // If same track is playing, just pause/play
        collectionPlayer.pauseVideo();
        return;
    }

    currentCollectionTrackIndex = index;
    const track = collectionTracks[index];

    // Update video info
    updateCollectionVideoInfo(track);

    // Update track list UI
    updateCollectionTrackListUI(index);

    // Load YouTube player
    if (collectionPlayer) {
        collectionPlayer.loadVideoById(track.youtube_id);
        hideCollectionLoadingPlaceholder();
    } else {
        initCollectionYouTubePlayer(track.youtube_id);
    }

    isCollectionPlaying = true;
}

function updateCollectionVideoInfo(track) {
    document.getElementById('collection-current-title').textContent = track.title;
    document.getElementById('collection-current-artist').textContent = track.artist || 'Unknown Artist';
    document.getElementById('collection-current-duration').textContent = track.duration || '--:--';
    document.getElementById('collection-current-views').textContent = track.view_count ? track.view_count.toLocaleString() : '--';
}

function updateCollectionTrackListUI(playingIndex) {
    // Remove all playing states
    document.querySelectorAll('#collection-track-list .track-item').forEach((item, index) => {
        item.classList.remove('playing');
        const numberEl = document.getElementById(`collection-track-number-${index}`);
        if (numberEl) {
            numberEl.textContent = index + 1;
            numberEl.classList.remove('playing');
        }
    });

    // Add playing state to current track
    const currentItem = document.querySelectorAll('#collection-track-list .track-item')[playingIndex];
    if (currentItem) {
        currentItem.classList.add('playing');
        const numberEl = document.getElementById(`collection-track-number-${playingIndex}`);
        if (numberEl) {
            numberEl.innerHTML = '<i class="fas fa-volume-up"></i>';
            numberEl.classList.add('playing');
        }

        // Scroll into view
        currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

function initCollectionYouTubePlayer(videoId) {
    if (!window.YT) {
        const script = document.createElement('script');
        script.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(script);

        window.onYouTubeIframeAPIReady = function() {
            createCollectionPlayer(videoId);
        };
    } else {
        createCollectionPlayer(videoId);
    }
}

function createCollectionPlayer(videoId) {
    collectionPlayer = new YT.Player('collection-youtube-player', {
        height: '100%',
        width: '100%',
        videoId: videoId,
        playerVars: {
            'playsinline': 1,
            'rel': 0,
            'modestbranding': 1,
            'controls': 1,
            'showinfo': 0,
            'autoplay': 1
        },
        events: {
            'onStateChange': onCollectionPlayerStateChange
        }
    });

    hideCollectionLoadingPlaceholder();
}

function hideCollectionLoadingPlaceholder() {
    document.getElementById('collection-loading-placeholder').style.display = 'none';
}

function onCollectionPlayerStateChange(event) {
    if (event.data == YT.PlayerState.ENDED) {
        // Auto-play next track
        if (currentCollectionTrackIndex < collectionTracks.length - 1) {
            playCollectionTrack(currentCollectionTrackIndex + 1);
        }
    } else if (event.data == YT.PlayerState.PLAYING) {
        isCollectionPlaying = true;
    } else if (event.data == YT.PlayerState.PAUSED) {
        isCollectionPlaying = false;
    }
}

// Stop collection video when modal is closed
document.getElementById('collectionPlayerModal').addEventListener('hidden.bs.modal', function() {
    if (collectionPlayer && collectionPlayer.pauseVideo) {
        collectionPlayer.pauseVideo();
    }
    // Reset state
    currentCollectionTrackIndex = -1;
    isCollectionPlaying = false;
});

// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const importCta = document.querySelector('.import-cta');
    if (importCta) {
        importCta.addEventListener('click', function() {
            const importUrl = this.dataset.importUrl;
            if (importUrl) {
                window.location.href = importUrl;
            }
        });
    }

    // Collection player modal functionality
    const collectionCards = document.querySelectorAll('.collection-thumbnail-container');
    collectionCards.forEach(card => {
        card.addEventListener('click', function() {
            const collectionId = parseInt(this.dataset.collectionId);
            const collectionName = this.dataset.collectionName;
            const collectionPlatform = this.dataset.collectionPlatform;
            const collectionCount = parseInt(this.dataset.collectionCount);

            openCollectionPlayer(collectionId, collectionName, collectionPlatform, collectionCount);
        });
    });
});

// Save for offline functionality
document.addEventListener('DOMContentLoaded', function() {
    const saveOfflineButtons = document.querySelectorAll('.save-offline-btn');
    saveOfflineButtons.forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const trackId = this.dataset.trackId;
            const icon = this.querySelector('i');
            
            // Show loading state
            icon.className = 'fas fa-spinner fa-spin';
            this.disabled = true;
            
            try {
                // Fetch track data and save to IndexedDB
                const response = await fetch(`/api/tracks/${trackId}/`);
                const track = await response.json();
                
                // Save to IndexedDB
                await saveTrackOffline(track);
                
                // Update UI
                icon.className = 'fas fa-check text-success';
                this.title = 'Saved offline';
                
            } catch (error) {
                console.error('Error saving track offline:', error);
                icon.className = 'fas fa-download';
                this.disabled = false;
            }
        });
    });
});

// IndexedDB functions
async function saveTrackOffline(track) {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('relaxify-db', 1);
        
        request.onerror = () => reject(request.error);
        
        request.onsuccess = () => {
            const db = request.result;
            const transaction = db.transaction(['tracks'], 'readwrite');
            const store = transaction.objectStore('tracks');
            
            const addRequest = store.put(track);
            addRequest.onsuccess = () => resolve();
            addRequest.onerror = () => reject(addRequest.error);
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('tracks')) {
                const store = db.createObjectStore('tracks', { keyPath: 'id' });
                store.createIndex('title', 'title', { unique: false });
            }
        };
    });
}
</script>
{% endblock %} 