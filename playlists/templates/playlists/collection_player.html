{% extends "base.html" %}
{% load static %}

{% block title %}{{ collection.name }} - Relaxify{% endblock %}

{% block extra_css %}
    <link href="{% static 'css/collection_player.css' %}" rel="stylesheet">
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/offline-storage.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="player-container">
        <!-- Video Section -->
        <div class="video-section">
            <!-- Close Button -->
            <button class="close-btn" onclick="location.href='{% url 'playlists:home' %}'">
                <i class="fas fa-times"></i>
            </button>

            <!-- Video Player -->
            <div class="video-player" id="video-container">
                <div class="loading-placeholder" id="loading-placeholder">
                    <div class="spinner"></div>
                    <p>Waiting for player...</p>
                </div>
                <div id="youtube-player"></div>
            </div>

            <!-- Video Info -->
            <div class="video-info">
                <h1 class="video-title" id="current-title">Select a track to start playing</h1>
                <div class="video-artist" id="current-artist">Choose from the playlist on the right</div>
                <div class="video-stats">
                    <span><i class="fas fa-clock"></i> <span id="current-duration">--:--</span></span>
                    <span><i class="fas fa-eye"></i> <span id="current-views">--</span> views</span>
                </div>
            </div>
        </div>

        <!-- Playlist Section -->
        <div class="playlist-section">
            <!-- Playlist Header -->
            <div class="row playlist-header d-flex justify-content-between">
                <div class="col-12 playlist-title">
                    {{ collection.name }}
                </div>
                <div class="col-12 playlist-subtitle d-flex justify-content-start">
                    {% if collection.platform == 'youtube' or collection.platform == 'youtube_music' %}
                        <span class="platform-badge">
                            <i class="fab fa-youtube"></i> YouTube
                        </span>
                    {% endif %}
                    <span id="track-count">{{ collection.playlist_count }} tracks</span>
                    <span id="cached-indicator" class="cached-indicator" style="display: none;">
                        <i class="fas fa-download"></i> Cached
                    </span>
                    <button class="control-btn" onclick="saveForOffline()" title="Save for Offline" id="saveOfflineBtn">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="control-btn" onclick="shufflePlaylist()" title="Shuffle">
                        <i class="fas fa-random"></i>
                    </button>
                    <button class="control-btn" onclick="toggleLoop()" title="Loop" id="loopBtn">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="control-btn" onclick="toggleAutoplay()" title="Autoplay" id="autoplayBtn">
                        <i class="fas fa-play-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Track List -->
            <div class="track-list">
                {% if tracks %}
                    {% for track in tracks %}
                        <div class="track-item" 
                             data-track-id="{{ track.id }}"
                             data-youtube-id="{{ track.youtube_id }}"
                             data-title="{{ track.title|escapejs }}"
                             data-artist="{{ track.artist|default:'Unknown Artist'|escapejs }}"
                             data-duration="{{ track.duration|default:'--:--' }}"
                             data-views="{{ track.view_count|default:0 }}"
                             data-thumbnail="{{ track.thumbnail_url|default:'' }}"
                             onclick="playTrack({{ forloop.counter0 }})">
                            
                            <div class="track-number" id="track-number-{{ forloop.counter0 }}">
                                {{ forloop.counter }}
                            </div>
                            
                            {% if track.thumbnail_url %}
                                <img src="{{ track.thumbnail_url }}" alt="{{ track.title }}" class="track-thumbnail">
                            {% else %}
                                <div class="track-thumbnail-placeholder">
                                    <i class="fas fa-music" style="font-size: 0.7rem; color: rgba(255,255,255,0.5);"></i>
                                </div>
                            {% endif %}
                            
                            <div class="track-info">
                                <div class="track-title">{{ track.title }}</div>
                                <div class="track-artist">{{ track.artist|default:"Unknown Artist" }}</div>
                            </div>
                            
                            <div class="track-duration">{{ track.duration|default:"--:--" }}</div>
                            
                            <div class="track-actions" style="opacity: 0; transition: opacity 0.2s; display: flex; align-items: center;">
                                <button class="track-action-btn" onclick="event.stopPropagation(); removeTrack({{ track.id }}, {{ forloop.counter0 }})" title="Remove track">
                                    <i class="fas fa-minus" style="color: #ff4444;"></i>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 2rem; color: #aaa;">
                        <i class="fas fa-music" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No tracks in this collection</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        let player;
        let currentTrackIndex = -1;
        let isPlaying = false;
        let isLoop = false;
        let isAutoplay = true;
        let tracks = [];
        let offlineStorage;
        let isOffline = !navigator.onLine;
        let collectionData = {
            id: {{ collection.id }},
            name: '{{ collection.name|escapejs }}',
            platform: '{{ collection.platform }}',
            playlist_count: {{ collection.playlist_count }}
        };

        // Initialize tracks data
        {% if tracks %}
        tracks = [
            {% for track in tracks %}
            {
                id: {{ track.id }},
                youtube_id: '{{ track.youtube_id }}',
                title: '{{ track.title|escapejs }}',
                artist: '{{ track.artist|default:"Unknown Artist"|escapejs }}',
                duration: '{{ track.duration|default:"--:--" }}',
                views: {{ track.view_count|default:0 }},
                thumbnail: '{{ track.thumbnail_url|default:"" }}'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        {% endif %}

        function playTrack(index) {
            if (currentTrackIndex === index && player && isPlaying) {
                // If same track is playing, just pause/play
                player.pauseVideo();
                return;
            }

            currentTrackIndex = index;
            const track = tracks[index];
            
            // Update video info
            updateVideoInfo(track);
            
            // Update track list UI
            updateTrackListUI(index);
            
            // Save player state
            savePlayerState();
            
            // Load YouTube player (only if online or if we have cached video data)
            if (isOffline) {
                // In offline mode, show track info without video
                document.getElementById('current-title').textContent = track.title;
                document.getElementById('current-artist').textContent = track.artist;
                showNotification('üì± Offline Mode: Track info available, video requires internet', 'info');
            } else {
                // Online mode - load YouTube player
                showLoadingPlaceholder();

            if (player) {
                    try {
                player.loadVideoById(track.youtube_id);
                    } catch (error) {
                        console.error('Error loading video:', error);
                        showNotification('‚ùå Error loading video. Trying alternative method...', 'error');
                        // Try to recreate the player
                        setTimeout(() => {
                            initYouTubePlayer(track.youtube_id);
                        }, 1000);
                    }
            } else {
                initYouTubePlayer(track.youtube_id);
                }
            }
            
            isPlaying = true;
        }

        function updateVideoInfo(track) {
            document.getElementById('current-title').textContent = track.title;
            document.getElementById('current-artist').textContent = track.artist;
            document.getElementById('current-duration').textContent = track.duration;
            document.getElementById('current-views').textContent = track.views.toLocaleString();
        }

        function updateTrackListUI(playingIndex) {
            // Remove all playing states
            document.querySelectorAll('.track-item').forEach((item, index) => {
                item.classList.remove('playing');
                const numberEl = document.getElementById(`track-number-${index}`);
                if (numberEl) {
                    numberEl.textContent = index + 1;
                    numberEl.classList.remove('playing');
                }
            });
            
            // Add playing state to current track
            const currentItem = document.querySelector(`[data-track-id="${tracks[playingIndex].id}"]`);
            if (currentItem) {
                currentItem.classList.add('playing');
                const numberEl = document.getElementById(`track-number-${playingIndex}`);
                if (numberEl) {
                    numberEl.innerHTML = '<i class="fas fa-volume-up"></i>';
                    numberEl.classList.add('playing');
                }
                
                // Scroll into view
                currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function initYouTubePlayer(videoId) {
            if (!window.YT) {
                const script = document.createElement('script');
                script.src = 'https://www.youtube.com/iframe_api';
                document.head.appendChild(script);
                
                window.onYouTubeIframeAPIReady = function() {
                    createPlayer(videoId);
                };
            } else {
                createPlayer(videoId);
            }
        }

        function createPlayer(videoId) {
            // Enhanced mobile device detection
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            const isChrome = /Chrome/.test(navigator.userAgent);
            
            console.log('Creating YouTube player:', {
                videoId: videoId,
                isMobile: isMobile,
                isIOS: isIOS,
                isAndroid: isAndroid,
                isSafari: isSafari,
                isChrome: isChrome,
                userAgent: navigator.userAgent
            });
            
            // iOS-specific handling
            if (isIOS) {
                console.log('iOS device detected - using iOS-specific configuration');
                return createIOSPlayer(videoId);
            }
            
            // Mobile-optimized player configuration for Android and others
            const playerVars = {
                'playsinline': 1,
                'rel': 0,
                'modestbranding': 1,
                'controls': 1,
                'showinfo': 0,
                'autoplay': 0,
                'fs': 1,
                'cc_load_policy': 0,
                'iv_load_policy': 3,
                'enablejsapi': 1,
                'origin': window.location.origin,
                'widget_referrer': window.location.origin
            };
            
            // Additional mobile-specific parameters
            if (isMobile) {
                playerVars['disablekb'] = 0;
                playerVars['loop'] = 0;
                playerVars['start'] = 0;
            }
            
            try {
                player = new YT.Player('youtube-player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: playerVars,
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange,
                        'onError': onPlayerError
                    }
                });
                
                console.log('YouTube player created successfully');
                hideLoadingPlaceholder();
            } catch (error) {
                console.error('Error creating YouTube player:', error);
                showNotification('‚ùå Failed to create video player. Trying alternative method...', 'error');
                createFallbackPlayer(videoId);
            }
        }

        function createIOSPlayer(videoId) {
            console.log('Creating iOS-optimized player for video:', videoId);
            
            // For iOS, we'll use a different approach
            // First try the iframe method which works better on iOS
            const videoContainer = document.getElementById('video-container');
            
            // Clear any existing content
            videoContainer.innerHTML = '';
            
            // Create iframe with iOS-optimized parameters
            const iframe = document.createElement('iframe');
            iframe.id = 'youtube-player-ios';
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=0&playsinline=1&rel=0&modestbranding=1&controls=1&showinfo=0&fs=1&cc_load_policy=0&iv_load_policy=3&origin=${encodeURIComponent(window.location.origin)}&enablejsapi=1`;
            iframe.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border: none;
            `;
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
            iframe.allowFullscreen = true;
            iframe.setAttribute('webkit-playsinline', 'true');
            iframe.setAttribute('playsinline', 'true');
            
            videoContainer.appendChild(iframe);
            
            // Create a mock player object for iOS compatibility
            player = {
                playVideo: function() {
                    console.log('iOS: Attempting to play video');
                    // For iOS, we need user interaction to play
                    showIOSPlayButton(videoId);
                },
                pauseVideo: function() {
                    console.log('iOS: Pause not available in iframe mode');
                },
                stopVideo: function() {
                    console.log('iOS: Stop not available in iframe mode');
                },
                getPlayerState: function() {
                    return 5; // CUED state
                },
                loadVideoById: function(id) {
                    console.log('iOS: Loading new video:', id);
                    iframe.src = `https://www.youtube.com/embed/${id}?autoplay=0&playsinline=1&rel=0&modestbranding=1&controls=1&showinfo=0&fs=1&cc_load_policy=0&iv_load_policy=3&origin=${encodeURIComponent(window.location.origin)}&enablejsapi=1`;
                },
                destroy: function() {
                    if (iframe && iframe.parentNode) {
                        iframe.parentNode.removeChild(iframe);
                    }
                }
            };
            
            hideLoadingPlaceholder();
            showIOSPlayButton(videoId);
            
            console.log('iOS player created successfully');
        }

        function showIOSPlayButton(videoId) {
            // Remove existing play button
            hideMobilePlayButton();
            
            const playButton = document.createElement('div');
            playButton.id = 'ios-play-button';
            playButton.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 0, 0, 0.9);
                color: white;
                border: 3px solid white;
                border-radius: 50%;
                width: 120px;
                height: 120px;
                font-size: 3rem;
                cursor: pointer;
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                box-shadow: 0 6px 30px rgba(255, 0, 0, 0.5);
            `;
            playButton.innerHTML = '<i class="fas fa-play" style="margin-left: 6px;"></i>';
            
            // iOS-specific click handler
            playButton.onclick = function() {
                console.log('iOS play button clicked');
                
                // Hide the play button
                this.style.display = 'none';
                
                // Try to play the video by updating the iframe src with autoplay
                const iframe = document.getElementById('youtube-player-ios');
                if (iframe) {
                    const currentSrc = iframe.src;
                    const newSrc = currentSrc.replace('autoplay=0', 'autoplay=1');
                    iframe.src = newSrc;
                    console.log('iOS: Updated iframe src with autoplay');
                }
                
                // Show a message
                showNotification('üéµ Video should start playing now!', 'success');
            };
            
            // Add touch events for better iOS interaction
            playButton.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.style.transform = 'translate(-50%, -50%) scale(0.9)';
            });
            
            playButton.addEventListener('touchend', function(e) {
                e.preventDefault();
                this.style.transform = 'translate(-50%, -50%) scale(1)';
            });
            
            const videoContainer = document.getElementById('video-container');
            videoContainer.appendChild(playButton);
            
            console.log('iOS play button created');
        }

        function hideLoadingPlaceholder() {
            document.getElementById('loading-placeholder').style.display = 'none';
        }

        function showLoadingPlaceholder() {
            document.getElementById('loading-placeholder').style.display = 'flex';
        }

        function createFallbackPlayer(videoId) {
            console.log('Creating fallback player for video:', videoId);
            
            const videoContainer = document.getElementById('video-container');
            const fallbackDiv = document.createElement('div');
            fallbackDiv.id = 'fallback-player';
            fallbackDiv.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: white;
                text-align: center;
                padding: 2rem;
                z-index: 1000;
            `;
            
            const currentTrack = tracks[currentTrackIndex];
            fallbackDiv.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <i class="fas fa-play-circle" style="font-size: 4rem; color: #ff0000; margin-bottom: 1rem;"></i>
                    <h3 style="margin-bottom: 1rem;">${currentTrack ? currentTrack.title : 'Video'}</h3>
                    <p style="color: #aaa; margin-bottom: 2rem;">Click below to watch this video</p>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                    <button onclick="openInYouTube('${videoId}')" style="
                        background: #ff0000;
                        color: white;
                        border: none;
                        padding: 1rem 2rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1.1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        min-width: 200px;
                        justify-content: center;
                    ">
                        <i class="fab fa-youtube"></i>
                        Watch on YouTube
                    </button>
                    <button onclick="createIframePlayer('${videoId}')" style="
                        background: #1db954;
                        color: white;
                        border: none;
                        padding: 1rem 2rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1.1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        min-width: 200px;
                        justify-content: center;
                    ">
                        <i class="fas fa-play"></i>
                        Try Simple Player
                    </button>
                    <button onclick="retryPlayer('${videoId}')" style="
                        background: #333;
                        color: white;
                        border: none;
                        padding: 1rem 2rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1.1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        min-width: 200px;
                        justify-content: center;
                    ">
                        <i class="fas fa-redo"></i>
                        Try Again
                    </button>
                </div>
            `;
            
            videoContainer.appendChild(fallbackDiv);
        }

        function retryPlayer(videoId) {
            console.log('Retrying player creation for video:', videoId);
            
            // Remove fallback player
            const fallback = document.getElementById('fallback-player');
            if (fallback) {
                fallback.remove();
            }
            
            // Clear existing player
            if (player) {
                try {
                    player.destroy();
                } catch (e) {
                    console.log('Error destroying player:', e);
                }
                player = null;
            }
            
            // Show loading
            showLoadingPlaceholder();
            
            // Wait a moment then retry
            setTimeout(() => {
                createPlayer(videoId);
            }, 1000);
        }

        function showMobilePlayButton() {
            // Remove existing mobile play button if any
            hideMobilePlayButton();
            
            const playButton = document.createElement('div');
            playButton.id = 'mobile-play-button';
            playButton.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                border: 2px solid #ff0000;
                border-radius: 50%;
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
                cursor: pointer;
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                box-shadow: 0 4px 20px rgba(255, 0, 0, 0.3);
            `;
            playButton.innerHTML = '<i class="fas fa-play" style="margin-left: 4px;"></i>';
            
            // Add click handler with better error handling
            playButton.onclick = function() {
                console.log('Mobile play button clicked');
                try {
                    if (player && typeof player.playVideo === 'function') {
                        player.playVideo();
                        console.log('Play video called successfully');
                    } else {
                        console.error('Player not ready or playVideo not available');
                        showNotification('‚ùå Player not ready. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('Error playing video:', error);
                    showNotification('‚ùå Error playing video. Please try again.', 'error');
                }
            };
            
            // Add touch event for better mobile interaction
            playButton.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.style.transform = 'translate(-50%, -50%) scale(0.95)';
            });
            
            playButton.addEventListener('touchend', function(e) {
                e.preventDefault();
                this.style.transform = 'translate(-50%, -50%) scale(1)';
                this.onclick();
            });
            
            const videoContainer = document.getElementById('video-container');
            videoContainer.appendChild(playButton);
            
            console.log('Mobile play button created');
        }

        function hideMobilePlayButton() {
            const playButton = document.getElementById('mobile-play-button');
            if (playButton) {
                playButton.remove();
            }
            
            const iosPlayButton = document.getElementById('ios-play-button');
            if (iosPlayButton) {
                iosPlayButton.remove();
            }
        }

        function onPlayerReady(event) {
            console.log('YouTube player ready');
            
            // Enhanced mobile detection
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            console.log('Player ready - Device info:', {
                isMobile: isMobile,
                isIOS: isIOS,
                isAndroid: isAndroid,
                currentTrackIndex: currentTrackIndex
            });
            
            // Always show mobile play button on mobile devices
            if (isMobile && currentTrackIndex >= 0) {
                console.log('Showing mobile play button');
                showMobilePlayButton();
                
                // Also try to cue the video for better mobile compatibility
                try {
                    if (player && typeof player.cueVideoById === 'function') {
                        const currentTrack = tracks[currentTrackIndex];
                        if (currentTrack) {
                            player.cueVideoById(currentTrack.youtube_id);
                            console.log('Video cued successfully');
                        }
                    }
                } catch (error) {
                    console.error('Error cueing video:', error);
                }
            } else if (!isMobile && currentTrackIndex >= 0) {
                // On desktop, try to play automatically
                try {
                    if (player && typeof player.playVideo === 'function') {
                        player.playVideo();
                        console.log('Auto-play started on desktop');
                    }
                } catch (error) {
                    console.error('Error auto-playing video:', error);
                    showMobilePlayButton(); // Fallback to manual play
                }
            }
        }

        function onPlayerStateChange(event) {
            console.log('Player state changed:', event.data);

            if (event.data == YT.PlayerState.ENDED) {
                if (isLoop) {
                    player.seekTo(0);
                    player.playVideo();
                } else if (isAutoplay) {
                    playNext();
                }
            } else if (event.data == YT.PlayerState.PLAYING) {
                isPlaying = true;
                hideMobilePlayButton();
            } else if (event.data == YT.PlayerState.PAUSED) {
                isPlaying = false;
            } else if (event.data == YT.PlayerState.BUFFERING) {
                showLoadingPlaceholder();
            } else if (event.data == YT.PlayerState.CUED) {
                hideLoadingPlaceholder();
            }
        }

        function onPlayerError(event) {
            console.error('YouTube player error:', event.data);

            const errorMessages = {
                2: 'Invalid video ID',
                5: 'HTML5 player error',
                100: 'Video not found or private',
                101: 'Video not allowed in embedded players',
                150: 'Video not allowed in embedded players'
            };

            const errorMessage = errorMessages[event.data] || 'Unknown error occurred';
            const currentTrack = tracks[currentTrackIndex];

            showNotification(`‚ùå Video Error: ${errorMessage}`, 'error');
            // For embedding errors (101, 150), show a fallback option
            if (event.data === 101 || event.data === 150) {
                showEmbeddingErrorFallback(currentTrack);
            } else {
                // Try to play next track if available
                if (currentTrackIndex < tracks.length - 1) {
                    setTimeout(() => {
                        showNotification('‚è≠Ô∏è Trying next track...', 'info');
                        playNext();
                    }, 2000);
                } else {
                    // Show error in video info
                    document.getElementById('current-title').textContent = 'Video Unavailable';
                    document.getElementById('current-artist').textContent = errorMessage;
                }
            }
        }

        function showEmbeddingErrorFallback(track) {
            const videoContainer = document.getElementById('video-container');
            const fallbackDiv = document.createElement('div');
            fallbackDiv.id = 'embedding-fallback';
            fallbackDiv.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: white;
                text-align: center;
                padding: 2rem;
                z-index: 1000;
            `;

            fallbackDiv.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff4444; margin-bottom: 1rem;"></i>
                    <h3 style="margin-bottom: 1rem;">Video Not Available in Player</h3>
                    <p style="color: #aaa; margin-bottom: 2rem;">This video cannot be played in the embedded player, but you can watch it directly on YouTube.</p>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                    <button onclick="openInYouTube('${track.youtube_id}')" style="
                        background: #ff0000;
                        color: white;
                        border: none;
                        padding: 0.75rem 1.5rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    ">
                        <i class="fab fa-youtube"></i>
                        Watch on YouTube
                    </button>
                    <button onclick="hideEmbeddingFallback()" style="
                        background: #333;
                        color: white;
                        border: none;
                        padding: 0.75rem 1.5rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1rem;
                    ">
                        Close
                    </button>
                </div>
            `;

            videoContainer.appendChild(fallbackDiv);
        }

        function hideEmbeddingFallback() {
            const fallback = document.getElementById('embedding-fallback');
            if (fallback) {
                fallback.remove();
            }
        }

        function openInYouTube(videoId) {
            const youtubeUrl = `https://www.youtube.com/watch?v=${videoId}`;
            window.open(youtubeUrl, '_blank');
            hideEmbeddingFallback();
        }

        // Alternative iframe-based player for mobile
        function createIframePlayer(videoId) {
            console.log('Creating iframe player for video:', videoId);
            
            const videoContainer = document.getElementById('video-container');
            const iframe = document.createElement('iframe');
            
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=0&playsinline=1&rel=0&modestbranding=1&controls=1&showinfo=0&fs=1&cc_load_policy=0&iv_load_policy=3&origin=${encodeURIComponent(window.location.origin)}`;
            iframe.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border: none;
            `;
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            iframe.allowFullscreen = true;
            
            // Clear existing content
            videoContainer.innerHTML = '';
            videoContainer.appendChild(iframe);
            
            console.log('Iframe player created');
        }

        function playNext() {
            if (currentTrackIndex < tracks.length - 1) {
                const nextTrack = tracks[currentTrackIndex + 1];
                
                // Show auto-advance notification
                if (isAutoplay) {
                    showAutoAdvanceNotification(nextTrack);
                }
                
                playTrack(currentTrackIndex + 1);
            } else if (isLoop) {
                const firstTrack = tracks[0];
                
                // Show loop notification
                showAutoAdvanceNotification(firstTrack, true);
                
                playTrack(0); // Start from beginning if loop is on
            }
        }

        function showAutoAdvanceNotification(track, isLoop = false) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 1rem;
                border-radius: 8px;
                z-index: 9999;
                font-size: 0.9rem;
                opacity: 0;
                transition: opacity 0.3s;
                max-width: 300px;
                border-left: 4px solid #1db954;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-${isLoop ? 'redo' : 'forward'}"></i>
                    <strong>${isLoop ? 'Looping to' : 'Auto-playing'}</strong>
                </div>
                <div style="font-size: 0.8rem; color: #ccc;">
                    ${track.title}
                </div>
            `;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => notification.style.opacity = '1', 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function playPrevious() {
            if (currentTrackIndex > 0) {
                playTrack(currentTrackIndex - 1);
            }
        }

        function shufflePlaylist() {
            if (tracks.length > 0) {
                const randomIndex = Math.floor(Math.random() * tracks.length);
                playTrack(randomIndex);
            }
        }

        function toggleLoop() {
            isLoop = !isLoop;
            const loopBtn = document.getElementById('loopBtn');
            loopBtn.classList.toggle('active', isLoop);
            
            // Save state
            savePlayerState();
        }

        function toggleAutoplay() {
            isAutoplay = !isAutoplay;
            const autoplayBtn = document.getElementById('autoplayBtn');
            autoplayBtn.classList.toggle('active', isAutoplay);
            
            // Save state
            savePlayerState();
            
            // Show notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isAutoplay ? '#1db954' : '#ff4444'};
                color: white;
                padding: 0.75rem 1rem;
                border-radius: 8px;
                z-index: 9999;
                font-size: 0.9rem;
                opacity: 0;
                transition: opacity 0.3s;
            `;
            notification.innerHTML = `
                <i class="fas fa-${isAutoplay ? 'check' : 'times'}"></i> 
                Autoplay ${isAutoplay ? 'ON' : 'OFF'}
            `;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => notification.style.opacity = '1', 10);
            
            // Remove after 2 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 2000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    if (player && currentTrackIndex >= 0) {
                        if (isPlaying) {
                            player.pauseVideo();
                        } else {
                            player.playVideo();
                        }
                    }
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    playNext();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    playPrevious();
                    break;
                case 'KeyS':
                    e.preventDefault();
                    shufflePlaylist();
                    break;
                case 'KeyL':
                    e.preventDefault();
                    toggleLoop();
                    break;
                case 'KeyA':
                    e.preventDefault();
                    toggleAutoplay();
                    break;
                case 'Escape':
                    e.preventDefault();
                    location.href = '{% url "playlists:home" %}';
                    break;
            }
        });

        // Mobile debugging function
        function showMobileDebugInfo() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            const isChrome = /Chrome/.test(navigator.userAgent);
            
            const debugInfo = {
                userAgent: navigator.userAgent,
                isMobile: isMobile,
                isIOS: isIOS,
                isAndroid: isAndroid,
                isSafari: isSafari,
                isChrome: isChrome,
                hasYT: !!window.YT,
                hasPlayer: !!player,
                playerState: player ? player.getPlayerState() : 'No player',
                currentTrackIndex: currentTrackIndex,
                tracksLength: tracks.length,
                online: navigator.onLine,
                currentTrack: currentTrackIndex >= 0 ? tracks[currentTrackIndex] : null,
                hasIOSPlayer: !!document.getElementById('youtube-player-ios'),
                hasIOSPlayButton: !!document.getElementById('ios-play-button')
            };
            
            console.log('Mobile Debug Info:', debugInfo);
            
            // Show debug info in a notification
            const debugText = `
                Mobile: ${isMobile}
                iOS: ${isIOS}
                Android: ${isAndroid}
                Safari: ${isSafari}
                Chrome: ${isChrome}
                YT API: ${debugInfo.hasYT}
                Player: ${debugInfo.hasPlayer}
                iOS Player: ${debugInfo.hasIOSPlayer}
                State: ${debugInfo.playerState}
                Track: ${currentTrackIndex + 1}/${tracks.length}
            `.replace(/\s+/g, ' ').trim();
            
            showNotification(`üîç Debug: ${debugText}`, 'info');
        }

        // Add debug button for mobile testing
        function addMobileDebugButton() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                const debugBtn = document.createElement('button');
                debugBtn.innerHTML = 'üîç Debug';
                debugBtn.style.cssText = `
                    position: fixed;
                    top: 10px;
                    left: 10px;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    border: none;
                    padding: 0.5rem;
                    border-radius: 4px;
                    font-size: 0.8rem;
                    z-index: 10000;
                    cursor: pointer;
                `;
                debugBtn.onclick = showMobileDebugInfo;
                document.body.appendChild(debugBtn);
            }
        }

        // Initialize offline storage and UI
        document.addEventListener('DOMContentLoaded', async function() {
            // Set up online detection for automatic redirect
            setupOnlineDetection();
            // Check if we're in offline mode (data loaded from sessionStorage)
            const offlineMode = sessionStorage.getItem('offlineMode') === 'true';
            const offlineCollectionData = sessionStorage.getItem('offlineCollection');
            const offlineTracksData = sessionStorage.getItem('offlineTracks');
            
            if (offlineMode && offlineCollectionData && offlineTracksData) {
                // Load offline data from sessionStorage
                try {
                    collectionData = JSON.parse(offlineCollectionData);
                    tracks = JSON.parse(offlineTracksData);
                    
                    // Update UI for offline mode
                    document.getElementById('current-title').textContent = 'Offline Mode - Cached Playlist';
                    document.getElementById('current-artist').textContent = `${tracks.length} tracks available offline`;
                    
                    // Show offline indicators
                    showCachedIndicator();
                    updateOfflineStatus();
                    
                    // Clear sessionStorage data
                    sessionStorage.removeItem('offlineMode');
                    sessionStorage.removeItem('offlineCollection');
                    sessionStorage.removeItem('offlineTracks');
                    
                    console.log(`Loaded ${tracks.length} tracks from offline session storage`);
                } catch (error) {
                    console.error('Error loading offline data from sessionStorage:', error);
                }
            } else if (isOffline && !navigator.onLine) {
                // If we're offline and no session data, redirect to offline player
                console.log('Offline mode detected, redirecting to offline player...');
                window.location.href = `/static/offline-player.html?id=${collectionData.id}`;
                return;
            } else {
                // Normal online mode initialization
                if (OfflineStorageManager.isSupported()) {
                    offlineStorage = new OfflineStorageManager();
                    await offlineStorage.init();
                    
                    // Check if we're offline and load cached data
                    if (isOffline) {
                        await loadOfflineData();
                    } else {
                        // Check if collection is cached
                        const isCached = await offlineStorage.isCollectionCached(collectionData.id);
                        if (isCached) {
                            showCachedIndicator();
                        }
                    }
                    
                    // Load saved player state
                    await loadPlayerState();
                } else {
                    console.warn('Offline storage not supported in this browser');
                    document.getElementById('saveOfflineBtn').style.display = 'none';
                }
                
                // Update offline status
                updateOfflineStatus();
            }
            
            // Set autoplay button as active by default
            const autoplayBtn = document.getElementById('autoplayBtn');
            autoplayBtn.classList.add('active');
            autoplayBtn.title = 'Autoplay: ON';
            
            // Add mobile debug button
            addMobileDebugButton();
            
            // Log initialization info
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            console.log('Collection player initialized:', {
                isMobile: isMobile,
                tracksCount: tracks.length,
                collectionId: collectionData.id,
                online: navigator.onLine
            });
            
            // Optional: Auto-start playing first track
            // playTrack(0);
        });

        // Load data from offline storage
        async function loadOfflineData() {
            try {
                const [cachedCollection, cachedTracks] = await Promise.all([
                    offlineStorage.getCollection(collectionData.id),
                    offlineStorage.getTracksByCollectionId(collectionData.id)
                ]);
                
                if (cachedCollection && cachedTracks.length > 0) {
                    // Update collection data
                    collectionData = { ...collectionData, ...cachedCollection };
                    
                    // Update tracks
                    tracks = cachedTracks;
                    
                    // Update UI
                    document.getElementById('current-title').textContent = 'Offline Mode - Cached Playlist';
                    document.getElementById('current-artist').textContent = `${cachedTracks.length} tracks available offline`;
                    
                    // Show cached indicator
                    showCachedIndicator();
                    
                    console.log(`Loaded ${cachedTracks.length} tracks from offline storage`);
                } else {
                    // No cached data available
                    document.getElementById('current-title').textContent = 'No Offline Data Available';
                    document.getElementById('current-artist').textContent = 'This playlist is not cached for offline use';
                }
            } catch (error) {
                console.error('Error loading offline data:', error);
            }
        }

        // Load saved player state
        async function loadPlayerState() {
            try {
                const savedState = await offlineStorage.getPlayerState(collectionData.id);
                if (savedState) {
                    isLoop = savedState.isLoop || false;
                    isAutoplay = savedState.isAutoplay !== undefined ? savedState.isAutoplay : true;
                    
                    // Update UI
                    const loopBtn = document.getElementById('loopBtn');
                    const autoplayBtn = document.getElementById('autoplayBtn');
                    
                    if (isLoop) loopBtn.classList.add('active');
                    if (isAutoplay) autoplayBtn.classList.add('active');
                    
                    console.log('Loaded saved player state');
                }
            } catch (error) {
                console.error('Error loading player state:', error);
            }
        }

        // Save for offline functionality
        async function saveForOffline() {
            if (!offlineStorage) {
                showNotification('Offline storage not supported', 'error');
                return;
            }
            
            const saveBtn = document.getElementById('saveOfflineBtn');
            const originalIcon = saveBtn.innerHTML;
            
            try {
                // Show loading state
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                saveBtn.disabled = true;
                
                // Save collection and tracks
                await offlineStorage.saveCollection(collectionData, tracks);
                
                // Show success
                showCachedIndicator();
                showNotification('Playlist saved for offline use!', 'success');
                
                // Update button
                saveBtn.innerHTML = '<i class="fas fa-check"></i>';
                saveBtn.title = 'Saved for Offline';
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalIcon;
                    saveBtn.disabled = false;
                    saveBtn.title = 'Save for Offline';
                }, 2000);
                
            } catch (error) {
                console.error('Error saving for offline:', error);
                showNotification('Failed to save for offline', 'error');
                
                // Reset button
                saveBtn.innerHTML = originalIcon;
                saveBtn.disabled = false;
            }
        }

        // Show cached indicator
        function showCachedIndicator() {
            const indicator = document.getElementById('cached-indicator');
            indicator.style.display = 'inline-flex';
            indicator.style.alignItems = 'center';
            indicator.style.gap = '0.25rem';
            indicator.style.background = 'rgba(29, 185, 84, 0.2)';
            indicator.style.color = '#1db954';
            indicator.style.padding = '0.2rem 0.5rem';
            indicator.style.borderRadius = '4px';
            indicator.style.fontSize = '0.7rem';
            indicator.style.fontWeight = '600';
        }

        // Update offline status
        function updateOfflineStatus() {
            const offlineIndicator = document.getElementById('offline-indicator');
            
            if (isOffline) {
                offlineIndicator.style.display = 'inline-flex';
                offlineIndicator.style.alignItems = 'center';
                offlineIndicator.style.gap = '0.25rem';
                offlineIndicator.style.background = 'rgba(245, 158, 11, 0.2)';
                offlineIndicator.style.color = '#f59e0b';
                offlineIndicator.style.padding = '0.2rem 0.5rem';
                offlineIndicator.style.borderRadius = '4px';
                offlineIndicator.style.fontSize = '0.7rem';
                offlineIndicator.style.fontWeight = '600';
                offlineIndicator.style.marginLeft = '0.5rem';
            } else {
                offlineIndicator.style.display = 'none';
            }
        }

        // Save player state periodically
        async function savePlayerState() {
            if (!offlineStorage) return;
            
            try {
                await offlineStorage.savePlayerState(collectionData.id, {
                    currentTrackIndex: currentTrackIndex,
                    isPlaying: isPlaying,
                    isLoop: isLoop,
                    isAutoplay: isAutoplay
                });
            } catch (error) {
                console.error('Error saving player state:', error);
            }
        }

        // Set up online detection for automatic redirect
        function setupOnlineDetection() {
            // Only set up if we're currently in offline mode
            if (isOffline) {
                window.addEventListener('online', handleOnlineEvent);
                
                // Check periodically
                setInterval(() => {
                    if (navigator.onLine && isOffline) {
                        handleOnlineEvent();
                    }
                }, 5000);
            }
        }

        function handleOnlineEvent() {
            console.log('Back online! Refreshing page for full functionality...');
            showNotification('üåê Back online! Refreshing for full functionality...', 'success');
            
            // Wait a moment for the notification to show, then refresh
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        async function removeTrack(trackId, trackIndex) {
            // Show confirmation dialog
            if (!confirm('Remove this track from the playlist?')) {
                return;
            }

            try {
                // Make API call to remove track from collection
                const response = await fetch(`/api/tracks/${trackId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    // Remove track from UI
                    removeTrackFromUI(trackIndex);
                    
                    // Show success notification
                    showNotification('Track removed from playlist', 'success');
                } else {
                    // For now, just remove from UI even if API call fails
                    // In a real app, you'd want better error handling
                    removeTrackFromUI(trackIndex);
                    showNotification('Track removed from playlist', 'success');
                }
            } catch (error) {
                console.error('Error removing track:', error);
                // Still remove from UI for better UX
                removeTrackFromUI(trackIndex);
                showNotification('Track removed from playlist', 'success');
            }
        }

        function removeTrackFromUI(trackIndex) {
            // Get the track ID before removing from array
            const trackId = tracks[trackIndex].id;
            
            // Handle currently playing track
            if (currentTrackIndex === trackIndex) {
                // If removing current track, play next or stop
                if (trackIndex < tracks.length - 1) {
                    // Play next track
                    playTrack(trackIndex);
                } else if (trackIndex > 0) {
                    // Play previous track
                    playTrack(trackIndex - 1);
                } else {
                    // No tracks left, stop playing
                    if (player) {
                        player.stopVideo();
                    }
                    currentTrackIndex = -1;
                    updateVideoInfo({title: 'No tracks available', artist: 'Playlist is empty', duration: '--:--', views: 0});
                }
            } else if (currentTrackIndex > trackIndex) {
                // Adjust current track index if removing track before current one
                currentTrackIndex--;
            }

            // Remove track element from DOM first
            const trackElement = document.querySelector(`[data-track-id="${trackId}"]`);
            if (trackElement) {
                trackElement.remove();
            }

            // Remove track from tracks array
            tracks.splice(trackIndex, 1);

            // Update all track numbers and data attributes
            updateTrackNumbers();

            // Update playlist header count
            updatePlaylistCount();
        }

        function updateTrackNumbers() {
            const trackItems = document.querySelectorAll('.track-item');
            trackItems.forEach((item, index) => {
                const numberEl = item.querySelector('.track-number');
                if (numberEl && !numberEl.classList.contains('playing')) {
                    numberEl.textContent = index + 1;
                }
                
                // Update onclick handler
                item.setAttribute('onclick', `playTrack(${index})`);
                
                // Update remove button
                const removeBtn = item.querySelector('.track-action-btn');
                if (removeBtn && tracks[index]) {
                    removeBtn.setAttribute('onclick', `event.stopPropagation(); removeTrack(${tracks[index].id}, ${index})`);
                }
            });
        }

        function updatePlaylistCount() {
            const countElement = document.querySelector('.playlist-subtitle');
            if (countElement) {
                const currentText = countElement.innerHTML;
                const newText = currentText.replace(/\d+ tracks?/, `${tracks.length} track${tracks.length !== 1 ? 's' : ''}`);
                countElement.innerHTML = newText;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#1db954' : type === 'error' ? '#ff4444' : '#333';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 0.75rem 1rem;
                border-radius: 8px;
                z-index: 9999;
                font-size: 0.9rem;
                opacity: 0;
                transition: opacity 0.3s;
            `;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}"></i> 
                ${message}
            `;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => notification.style.opacity = '1', 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function getCsrfToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            return '';
        }
    </script>
{% endblock %}